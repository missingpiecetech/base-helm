suite: test gateway
templates:
  - charts/your-app/templates/app.yaml
tests:
  - it: should basic template properly
    documentIndex: 2 # find the gateway manifest, in this case its the 3rd generated
    asserts:
      - isKind:
          of: Gateway
      - equal:
          path: metadata.name
          value: your-app
  - it: should have correct labels
    documentIndex: 2
    asserts:
      - equal:
          path: metadata.labels.owner
          value: ml
      - equal:
          path: metadata.labels.release
          value: latest
      - equal:
          path: metadata.labels.product
          value: your-app
      - equal:
          path: metadata.labels.type
          value: application
      - equal:
          path: metadata.labels.gitlab_project
          value: "your-app"
      - equal:
          path: metadata.labels.deploy_name
          value: va-your-app
      - equal:
          path: metadata.labels.app
          value: your-app
      - equal:
          path: metadata.labels.istio-injection
          value: enabled
  - it: should have cloudflare off by default
    documentIndex: 2
    asserts:
      - equal:
          path: metadata.annotations["external-dns.alpha.kubernetes.io/cloudflare-proxied"]
          value: "false"
  - it: should have correct selector
    documentIndex: 2
    asserts:
      - equal:
          path: spec.selector["istio"]
          value: ingressgateway-non-proxy
  - it: should have correct hosts
    documentIndex: 2
    asserts:
      - equal:
          path: spec.servers[0].hosts[0]
          value: your-app.dev.24mm.io
  - it: should have correct ports
    documentIndex: 2
    asserts:
      - equal:
          path: spec.servers[0].port.name
          value: https
      - equal:
          path: spec.servers[0].port.number
          value: 443
      - equal:
          path: spec.servers[0].port.protocol
          value: HTTPS
  - it: should have correct tls
    documentIndex: 2
    asserts:
      - equal:
          path: spec.servers[0].tls.credentialName
          value: star-dev-24mm-io
      - equal:
          path: spec.servers[0].tls.minProtocolVersion
          value: TLSV1_2
      - equal:
          path: spec.servers[0].tls.mode
          value: SIMPLE