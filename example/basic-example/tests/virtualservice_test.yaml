suite: test virtual service
templates:
  - charts/your-app/templates/app.yaml
tests:
  - it: should basic template properly
    documentIndex: 0 # find the vs manifest, in this case its the 1st generated
    asserts:
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.name
          value: your-app-svc
  - it: should have correct labels
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.labels.owner
          value: ml
      - equal:
          path: metadata.labels.release
          value: latest
      - equal:
          path: metadata.labels.product
          value: your-app
      - equal:
          path: metadata.labels.type
          value: application
      - equal:
          path: metadata.labels.gitlab_project
          value: "your-app"
      - equal:
          path: metadata.labels.deploy_name
          value: va-your-app
      - equal:
          path: metadata.labels.app
          value: your-app
      - equal:
          path: metadata.labels.istio-injection
          value: enabled
  - it: should have correct gateways
    documentIndex: 0
    asserts:
      - equal:
          path: spec.gateways[0]
          value: your-app
  - it: should have correct hosts
    documentIndex: 0
    release:
      namespace: dev
    asserts:
      - equal:
          path: spec.hosts[0]
          value: your-app.dev.24mm.io
  - it: should have correct allowOrigins
    documentIndex: 0
    asserts:
      - equal:
          path: spec.http[0].corsPolicy.allowOrigins[0].regex
          value: 'https://.*papps.*connected.*\.io'
  - it: should have correct match uri
    documentIndex: 0
    asserts:
      - equal:
          path: spec.http[0].match[0].uri.prefix
          value: "/"
  - it: should have correct route
    documentIndex: 0
    release:
      namespace: dev
    asserts:
      - equal:
          path: spec.http[0].route[0].destination.host
          value: "your-app-svc"
      - equal:
          path: spec.http[0].route[0].destination.port.number
          value: 8000
      - equal:
          path: spec.http[0].route[0].destination.subset
          value: "v1"
